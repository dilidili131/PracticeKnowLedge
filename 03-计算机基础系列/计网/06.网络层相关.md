# 网络层相关

## 1. ARP

​		ARP协议即**地址解析协议**，是根据IP地址获取MAC地址的一个网络层协议。

### 1.1 工作原理

​		ARP首先会发起一个请求数据包，数据包的首部包含了目标主机的IP地址，然后这个数据包会在链路层进行再次包装，生成以太网数据包，最终**由以太网广播给子网内的所有主机**，每一台主机都会接收到这个数据包，并取出标头里的IP地址，然后和自己的IP地址进行比较，如果相同就返回自己的MAC地址，如果不同就丢弃该数据包。ARP接收返回消息，以此确定目标机的MAC地址；与此同时，**ARP还会将返回的MAC地址与对应的IP地址存入本机ARP缓存中并保留一定时间**，下次请求时直接查询ARP缓存以节约资源。

### 1.2工作过程

​		主机A的IP地址为192.168.1.1，MAC地址为0A-11-22-33-44-01；

​		主机B的IP地址为192.168.1.2，MAC地址为0A-11-22-33-44-02；

​		当主机A要与主机B通信时，地址解析协议可以将主机B的IP地址（192.168.1.2）解析成主机B的MAC地址，以下为工作流程：

​		第1步：根据主机A上的路由表内容，IP确定用于访问主机B的转发IP地址是192.168.1.2。然后A主机在自己的本地ARP缓存中检查主机B的匹配MAC地址。

​		第2步：如果主机A在ARP缓存中没有找到映射，它将询问192.168.1.2的硬件地址，从而**将ARP请求帧广播到本地网络上的所有主机**。源主机A的IP地址和MAC地址都包括在ARP请求中。本地网络上的每台主机都接收到ARP请求并且检查是否与自己的IP地址匹配。如果主机发现请求的IP地址与自己的IP地址不匹配，它将丢弃ARP请求。

​		第3步：主机B确定ARP请求中的IP地址与自己的IP地址匹配，则将主机A的IP地址和MAC地址映射添加到本地ARP缓存中。

​		第4步：主机B将包含其MAC地址的ARP回复消息直接发送回主机A。

​		第5步：当主机A收到从主机B发来的ARP回复消息时，会用主机B的IP和MAC地址映射更新ARP缓存。本机缓存是有生存期的，生存期结束后，将再次重复上面的过程。主机B的MAC地址一旦确定，主机A就能向主机B发送IP通信了。

### 1.3 ARP报文格式

![](C:\Users\10852\Desktop\实习\img\计网\arp.png)

- 硬件类型：指明了发送方想知道的硬件接口类型，以太网的值为1；

- 协议类型：指明了发送方提供的高层协议类型，IP为0800（16进制）；

- 硬件地址长度和协议长度：指明了硬件地址和高层协议地址的长度，这样ARP报文就可以在任意硬件和任意协议的网络中使用；

- 操作类型：用来表示这个报文的类型，ARP请求为1，ARP响应为2，RARP请求为3，RARP响应为4；
- 发送方硬件地址（0-3字节）：源主机硬件地址的前3个字节；
- 发送方硬件地址（4-5字节）：源主机硬件地址的后3个字节；
- 发送方IP地址（0-1字节）：源主机硬件地址的前2个字节；
- 发送方IP地址（2-3字节）：源主机硬件地址的后2个字节；
- 目标硬件地址（0-1字节）：目的主机硬件地址的前2个字节；
- 目标硬件地址（2-5字节）：目的主机硬件地址的后4个字节；
- 目标IP地址（0-3字节）：目的主机的IP地址。

## 2.IP协议